#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat >&2 <<'EOF'
Usage:
  git q put        # opens $EDITOR, enqueues into topic derived from repo+branch
  git q readto     # reads stdin, enqueues into the same topic
  git q get        # dequeue (non-blocking)
  git q get --block
EOF
  exit 2
}

cmd="${1:-}"; shift || true
[[ -n "$cmd" ]] || usage

# Compute topic (align with claude_q.git_integration).
if [[ "$(git rev-parse --is-inside-work-tree 2>/dev/null || true)" != "true" ]]; then
  echo "git q: not in a git worktree (cannot derive topic)" >&2
  exit 1
fi

remote="$(git remote 2>/dev/null | head -n 1 || true)"
branch="$(git branch --show-current 2>/dev/null || true)"
[[ "$branch" == "HEAD" ]] && branch=""

topic=""
if [[ -n "$remote" && -n "$branch" ]]; then
  topic="${remote}:${branch}"
elif [[ -n "$remote" ]]; then
  topic="$remote"
elif [[ -n "$branch" ]]; then
  topic="$branch"
else
  echo "git q: cannot derive topic (no remote and no branch)" >&2
  exit 1
fi

exec q "$cmd" "$topic" "$@"
